version: '3.9'

services:

  # 1️⃣ MySQL for auth
  auth-mysql:
    image: mysql:8.0
    container_name: auth-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: auth
    ports:
      - "3306:3306"
    volumes:
      - ./sql/auth.sql:/docker-entrypoint-initdb.d/init.sql

  # 2️⃣ MySQL for product
  product-mysql:
    image: mysql:8.0
    container_name: product-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: product
    ports:
      - "3307:3306"  # 宿主机 3307，容器内仍是 3306
    volumes:
      - ./sql/product.sql:/docker-entrypoint-initdb.d/init.sql

  # 3️⃣ Nacos 服务
  nacos:
    image: nacos/nacos-server:2.2.3
    container_name: nacos
    environment:
      MODE: standalone
      PREFER_HOST_MODE: hostname
    ports:
      - "8848:8848"
    volumes:
      - ./nacos-data:/home/nacos/nacos-data  # 可挂载已有 Nacos 数据

  # 4️⃣ LDAP 服务
  ldap:
    image: osixia/openldap:1.5.0
    container_name: ldap
    environment:
      LDAP_ORGANISATION: "Example Corp"
      LDAP_DOMAIN: "example.com"
      LDAP_ADMIN_PASSWORD: admin
    ports:
      - "389:389"
    volumes:
      - ./ldap-data.ldif:/container/service/slapd/assets/config/bootstrap/ldif/50-bootstrap.ldif

  # 5️⃣ Auth 服务
  auth:
    build: ./auth
    container_name: auth
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mysql://auth-mysql:3306/auth?useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: nacos:8848
      SPRING_LDAP_URLS: ldap://ldap:389
    depends_on:
      - auth-mysql
      - nacos
      - ldap

  # 6️⃣ Product 服务
  product:
    build: ./product
    container_name: product
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:mysql://product-mysql:3306/product?useSSL=false&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: nacos:8848
    depends_on:
      - product-mysql
      - nacos

  # 7️⃣ Gateway 服务
  gateway:
    build: ./gateway
    container_name: gateway
    ports:
      - "7573:7573"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CLOUD_NACOS_DISCOVERY_SERVER-ADDR: nacos:8848
    depends_on:
      - auth
      - product
      - nacos
